# leads/forms.py
from django import forms
from leads.models import LeadList


class LeadSearchForm(forms.Form):
    """
    Form for searching leads with filters.
    Compatible with the LinkedIn API structure based on REAL data analysis.
    
    API Data Structure:
    - location: "United States" (actual country name)
    - region: "Northern America" (geographical region)
    - position: Job title
    - level: Seniority level
    - company_name: Company name
    - company_industry: Industry
    - company_headcount: Company size
    """
    
    # Basic Filters
    name = forms.CharField(
        max_length=200,
        required=False,
        label='Name',
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'e.g., John Smith',
        })
    )
    
    title = forms.CharField(
        max_length=200,
        required=False,
        label='Job Title',
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'e.g., Software Engineer, Director',
        })
    )
    
    company = forms.CharField(
        max_length=200,
        required=False,
        label='Company',
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'e.g., Google, Top 000',
        })
    )
    
    # Location Filters (based on API structure)
    # API uses "location" field for country names like "United States"
    location = forms.CharField(
        max_length=200,
        required=False,
        label='Country/Location',
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'e.g., United States, Canada, United Kingdom',
        })
    )
    
    # API uses "region" field for geographical regions
    region = forms.CharField(
        max_length=200,
        required=False,
        label='Geographical Region',
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'e.g., Northern America, Europe, Asia',
        })
    )
    
    # Industry Filter (API field: company_industry)
    industry = forms.CharField(
        max_length=200,
        required=False,
        label='Industry',
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'e.g., Technology, Construction, IT Services',
        })
    )
    
    # Seniority Filter (API field: level)
    SENIORITY_CHOICES = [
        ('', '-- All Levels --'),
        ('entry', 'Entry Level'),
        ('mid', 'Mid Level'),
        ('senior', 'Senior'),
        ('specialist', 'Specialist'),
        ('manager', 'Manager'),
        ('director', 'Director'),
        ('head', 'Head'),
        ('vp', 'VP'),
        ('c_level', 'C-Level'),
        ('owner', 'Owner/Founder'),
        ('partner', 'Partner'),
        ('intern', 'Intern'),
    ]
    
    seniority_level = forms.ChoiceField(
        choices=SENIORITY_CHOICES,
        required=False,
        label='Seniority Level',
        widget=forms.Select(attrs={
            'class': 'form-select',
        })
    )
    
    # Company Size Filter (API field: company_headcount)
    # Values taken from real API data
    COMPANY_SIZE_CHOICES = [
        ('', '-- All Sizes --'),
        ('Myself Only', 'Myself Only'),
        ('1-10 employees', '1-10 employees'),
        ('11-50 employees', '11-50 employees'),
        ('51-200 employees', '51-200 employees'),
        ('201-500 employees', '201-500 employees'),
        ('501-1000 employees', '501-1000 employees'),
        ('1001-5000 employees', '1001-5000 employees'),
        ('5001-10000 employees', '5001-10000 employees'),
        ('10001+ employees', '10001+ employees'),
    ]
    
    company_size = forms.ChoiceField(
        choices=COMPANY_SIZE_CHOICES,
        required=False,
        label='Company Size',
        widget=forms.Select(attrs={
            'class': 'form-select',
        })
    )
    
    # Keywords (searches in skills, headline, position)
    keywords = forms.CharField(
        max_length=500,
        required=False,
        label='Keywords',
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'Search in skills, headline, or bio',
        })
    )
    
    # Results limit
    limit = forms.IntegerField(
        initial=50,
        required=False,
        widget=forms.HiddenInput()
    )
    
    def get_filters_dict(self):
        """
        Return cleaned data as a dictionary for API consumption.
        Removes empty values.
        """
        if not self.is_valid():
            return {}
        
        filters = {}
        for field, value in self.cleaned_data.items():
            if value:  # Only include non-empty values
                filters[field] = value
        
        return filters


class CreateListForm(forms.ModelForm):
    """
    Form to create a new lead list.
    """
    
    class Meta:
        model = LeadList
        fields = ['name', 'description']
        widgets = {
            'name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'e.g., Hot Prospects Q1 2025',
                'required': True,
            }),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'placeholder': 'Optional description...',
                'rows': 3,
            }),
        }
        labels = {
            'name': 'List Name',
            'description': 'Description (Optional)',
        }


class AddToListForm(forms.Form):
    """
    Form to add a lead to an existing list or create a new one.
    """
    
    # Select existing list
    existing_list = forms.ModelChoiceField(
        queryset=LeadList.objects.all(),
        required=False,
        empty_label="-- Select Existing List --",
        widget=forms.Select(attrs={
            'class': 'form-select',
            'id': 'existing-list-select',
        })
    )
    
    # Or create new list
    new_list_name = forms.CharField(
        max_length=255,
        required=False,
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'Or create a new list...',
            'id': 'new-list-input',
        })
    )
    
    # Optional notes
    notes = forms.CharField(
        required=False,
        widget=forms.Textarea(attrs={
            'class': 'form-control',
            'placeholder': 'Add notes about this lead (optional)...',
            'rows': 2,
        })
    )
    
    def clean(self):
        """
        Validate that either existing_list or new_list_name is provided.
        """
        cleaned_data = super().clean()
        existing_list = cleaned_data.get('existing_list')
        new_list_name = cleaned_data.get('new_list_name')
        
        if not existing_list and not new_list_name:
            raise forms.ValidationError(
                "Please select an existing list or create a new one."
            )
        
        return cleaned_data
    
    def get_list_name(self):
        """
        Return the list name to use (either existing or new).
        """
        if self.cleaned_data.get('existing_list'):
            return self.cleaned_data['existing_list'].name
        return self.cleaned_data.get('new_list_name', '')