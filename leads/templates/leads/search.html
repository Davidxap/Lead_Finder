{% extends "leads/base.html" %}
{% load static %}

{% block title %}Search Leads{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> Filters</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{% url 'leads:search' %}">
                        <!-- Name Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Name</label>
                            {{ form.name }}
                            <small class="text-muted d-block mt-1">
                                e.g., John Smith
                            </small>
                        </div>

                        <!-- Job Title Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Job Title</label>
                            {{ form.title }}
                            <small class="text-muted d-block mt-1">
                                e.g., CEO, Software Engineer
                            </small>
                        </div>

                        <!-- Company Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Company</label>
                            {{ form.company }}
                            <small class="text-muted d-block mt-1">
                                e.g., Google, Microsoft
                            </small>
                        </div>

                        <!-- Location Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Location</label>
                            {{ form.location }}
                            <small class="text-muted d-block mt-1">
                                e.g., United States, London
                            </small>
                        </div>

                        <!-- Region Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Geographical Region</label>
                            {{ form.region }}
                        </div>

                        <!-- Industry Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Industry</label>
                            {{ form.industry }}
                        </div>

                        <!-- Seniority Level Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Seniority Level</label>
                            {{ form.seniority_level }}
                        </div>

                        <!-- Company Size Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Company Size</label>
                            {{ form.company_size }}
                        </div>

                        <!-- Keywords Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Keywords</label>
                            {{ form.keywords }}
                        </div>

                        <!-- Number of Results Selector -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-list-ol"></i> Results Limit
                            </label>
                            {{ form.limit }}
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Search Leads
                            </button>
                            <a href="{% url 'leads:search' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Clear Filters
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Results Area -->
        <div class="col-md-9">
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}

            {% if has_searched %}
            <!-- Stats Card -->
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h3 class="mb-0 text-primary">
                                <i class="fas fa-users"></i> {{ total_results }}
                            </h3>
                            <small class="text-muted">Lead(s) found</small>
                        </div>
                        <div class="col-md-6 text-end">
                            {% if page_obj %}
                            <span class="badge bg-secondary bg-opacity-25 text-dark border">
                                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                            </span>
                            <p class="text-muted">Use the filters on the left to discover potential leads.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if leads %}
            <!-- Results Table -->
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Title</th>
                                    <th>Company</th>
                                    <th>Location</th>
                                    <th>Industry</th>
                                    <th>Email</th>
                                    <th>LinkedIn</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lead in leads %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ lead.full_name|default:"N/A" }}</div>
                                        {% if lead.seniority_level %}
                                        <span class="badge bg-info text-dark">{{ lead.get_seniority_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ lead.current_title|default:"-" }}
                                        {% if lead.headline %}
                                        <br><small class="text-muted">{{ lead.headline|truncatewords:8 }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>{{ lead.current_company|default:"-" }}</div>
                                        {% if lead.company_size %}
                                        <small class="text-muted">{{ lead.company_size }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ lead.location|default:"-" }}
                                        {% if lead.country and lead.country != lead.location %}
                                        <br><small class="text-muted">{{ lead.country }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ lead.industry|default:"-" }}</td>
                                    <td>
                                        {% if lead.email %}
                                        <a href="mailto:{{ lead.email }}" class="btn btn-sm btn-outline-danger"
                                            title="{{ lead.email }}">
                                            <i class="fas fa-envelope"></i>
                                        </a>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if lead.linkedin_url %}
                                        <a href="{% if 'http' in lead.linkedin_url %}{{ lead.linkedin_url }}{% else %}https://{{ lead.linkedin_url }}{% endif %}"
                                            target="_blank" class="btn btn-sm btn-outline-primary"
                                            rel="noopener noreferrer">
                                            <i class="fab fa-linkedin"></i>
                                        </a>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success add-to-list-btn"
                                            data-external-id="{{ lead.external_id|default:'' }}"
                                            data-first-name="{{ lead.first_name|escapejs }}"
                                            data-last-name="{{ lead.last_name|escapejs }}"
                                            data-full-name="{{ lead.full_name|escapejs }}"
                                            data-email="{{ lead.email|default:''|escapejs }}"
                                            data-phone="{{ lead.phone|default:''|escapejs }}"
                                            data-linkedin-url="{{ lead.linkedin_url|escapejs }}"
                                            data-current-title="{{ lead.current_title|escapejs }}"
                                            data-current-company="{{ lead.current_company|escapejs }}"
                                            data-company-linkedin-url="{{ lead.company_linkedin_url|default:''|escapejs }}"
                                            data-headline="{{ lead.headline|escapejs }}"
                                            data-location="{{ lead.location|escapejs }}"
                                            data-country="{{ lead.country|escapejs }}"
                                            data-region="{{ lead.region|default:''|escapejs }}"
                                            data-industry="{{ lead.industry|escapejs }}"
                                            data-company-size="{{ lead.company_size|escapejs }}"
                                            data-company-domain="{{ lead.company_domain|default:''|escapejs }}"
                                            data-company-location="{{ lead.company_location|default:''|escapejs }}"
                                            data-company-founded="{{ lead.company_founded|default:''|escapejs }}"
                                            data-company-revenue="{{ lead.company_revenue|default:''|escapejs }}"
                                            data-company-subindustry="{{ lead.company_subindustry|default:''|escapejs }}"
                                            data-level="{{ lead.level|default:''|escapejs }}"
                                            data-department="{{ lead.department|default:''|escapejs }}"
                                            data-seniority-level="{{ lead.seniority_level|escapejs }}"
                                            data-skills="{{ lead.skills|escapejs }}" data-bio="{{ lead.bio|escapejs }}">
                                            <i class="fas fa-plus"></i> Add to List
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                    <div class="card-footer bg-white border-top-0 py-3">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center mb-0">
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link"
                                        href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                        aria-label="First">
                                        <span aria-hidden="true"><i class="fas fa-step-backward"></i></span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link"
                                        href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                        aria-label="Previous">
                                        <span aria-hidden="true"><i class="fas fa-chevron-left"></i></span>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-step-backward"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-chevron-left"></i></span>
                                </li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li
                                    class="page-item">
                                    <a class="page-link"
                                        href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                                    </li>
                                    {% endif %}
                                    {% endfor %}

                                    {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link"
                                            href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                            aria-label="Next">
                                            <span aria-hidden="true"><i class="fas fa-chevron-right"></i></span>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link"
                                            href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                            aria-label="Last">
                                            <span aria-hidden="true"><i class="fas fa-step-forward"></i></span>
                                        </a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link"><i class="fas fa-chevron-right"></i></span>
                                    </li>
                                    <li class="page-item disabled">
                                        <span class="page-link"><i class="fas fa-step-forward"></i></span>
                                    </li>
                                    {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <h5>No leads found</h5>
                <p class="mb-0">Try adjusting your search filters to find more results.</p>
            </div>
            {% endif %}
            {% else %}
            <!-- Initial Empty State -->
            <div class="text-center py-5">
                <i class="fas fa-search fa-5x text-muted mb-4"></i>
                <h3 class="text-muted">Start Your Lead Search</h3>
                <p class="text-muted">Use the filters on the left to discover potential leads.</p>
            </div>
            {% endif %}

            <!-- Add to List Modal -->
            <div class="modal fade" id="addToListModal" tabindex="-1" aria-labelledby="addToListModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="addToListModalLabel">
                                <i class="fas fa-plus-circle"></i> Add Lead to List
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <form method="POST" action="{% url 'leads:add_to_list' %}" id="addToListForm">
                            {% csrf_token %}
                            <div class="modal-body">
                                <div id="leadInfoDisplay" class="alert alert-info mb-3">
                                    <strong id="leadNameDisplay"></strong><br>
                                    <small id="leadTitleDisplay" class="text-muted"></small>
                                </div>

                                <input type="hidden" name="external_id" id="modal_external_id">
                                <input type="hidden" name="first_name" id="modal_first_name">
                                <input type="hidden" name="last_name" id="modal_last_name">
                                <input type="hidden" name="full_name" id="modal_full_name">
                                <input type="hidden" name="email" id="modal_email">
                                <input type="hidden" name="phone" id="modal_phone">
                                <input type="hidden" name="linkedin_url" id="modal_linkedin_url">
                                <input type="hidden" name="current_title" id="modal_current_title">
                                <input type="hidden" name="current_company" id="modal_current_company">
                                <input type="hidden" name="company_linkedin_url" id="modal_company_linkedin_url">
                                <input type="hidden" name="headline" id="modal_headline">
                                <input type="hidden" name="location" id="modal_location">
                                <input type="hidden" name="country" id="modal_country">
                                <input type="hidden" name="region" id="modal_region">
                                <input type="hidden" name="industry" id="modal_industry">
                                <input type="hidden" name="company_size" id="modal_company_size">
                                <input type="hidden" name="company_domain" id="modal_company_domain">
                                <input type="hidden" name="company_location" id="modal_company_location">
                                <input type="hidden" name="company_founded" id="modal_company_founded">
                                <input type="hidden" name="company_revenue" id="modal_company_revenue">
                                <input type="hidden" name="company_subindustry" id="modal_company_subindustry">
                                <input type="hidden" name="level" id="modal_level">
                                <input type="hidden" name="department" id="modal_department">
                                <input type="hidden" name="seniority_level" id="modal_seniority_level">
                                <input type="hidden" name="skills" id="modal_skills">
                                <input type="hidden" name="bio" id="modal_bio">

                                <div class="mb-3">
                                    <label for="listSelect" class="form-label fw-bold">
                                        <i class="fas fa-list"></i> Select Existing List
                                    </label>
                                    <select class="form-select" id="listSelect" name="list_id">
                                        <option value="">-- Choose a list --</option>
                                        {% for list in all_lists %}
                                        <option value="{{ list.name }}">{{ list.name }} ({{ list.get_lead_count }} leads)</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <label for="newListInput" class="form-label fw-bold">
                                    <i class="fas fa-plus"></i> Or Create New List
                                </label>
                                <input type="text" class="form-control" id="newListInput"
                                    placeholder="Enter new list name">
                                <small class="form-text text-muted">Leave blank to use selected list above</small>

                            <div class="mb-3">
                                <label for="notesTextarea" class="form-label fw-bold">
                                    <i class="fas fa-sticky-note"></i> Notes (Optional)
                                </label>
                                <textarea class="form-control" id="notesTextarea" name="notes" rows="3"
                                    placeholder="Add any notes about this lead..."></textarea>
                            </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Add to List
                        </button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
        {% endblock %}

        {% block extra_js %}
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const addToListModal = new bootstrap.Modal(document.getElementById('addToListModal'));
                const newListInput = document.getElementById('newListInput');
                const listSelect = document.getElementById('listSelect');

                newListInput.addEventListener('input', function () {
                    if (this.value.trim()) {
                        listSelect.disabled = true;
                    } else {
                        listSelect.disabled = false;
                    }
                });

                document.getElementById('addToListForm').addEventListener('submit', function (e) {
                    const newListValue = newListInput.value.trim();
                    const listSelectValue = listSelect.value;

                    let listNameInput = document.getElementById('final_list_name');
                    if (!listNameInput) {
                        listNameInput = document.createElement('input');
                        listNameInput.type = 'hidden';
                        listNameInput.name = 'list_name';
                        listNameInput.id = 'final_list_name';
                        this.appendChild(listNameInput);
                    }

                    if (newListValue) {
                        listNameInput.value = newListValue;
                    } else if (listSelectValue) {
                        listNameInput.value = listSelectValue;
                    } else {
                        e.preventDefault();
                        alert('Please select a list or create a new one.');
                        return false;
                    }
                });

                document.querySelectorAll('.add-to-list-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        const leadData = {
                            external_id: this.dataset.externalId || '',
                            first_name: this.dataset.firstName || '',
                            last_name: this.dataset.lastName || '',
                            full_name: this.dataset.fullName || '',
                            email: this.dataset.email || '',
                            phone: this.dataset.phone || '',
                            linkedin_url: this.dataset.linkedinUrl || '',
                            current_title: this.dataset.currentTitle || '',
                            current_company: this.dataset.currentCompany || '',
                            company_linkedin_url: this.dataset.companyLinkedinUrl || '',
                            headline: this.dataset.headline || '',
                            location: this.dataset.location || '',
                            country: this.dataset.country || '',
                            region: this.dataset.region || '',
                            industry: this.dataset.industry || '',
                            company_size: this.dataset.companySize || '',
                            company_domain: this.dataset.companyDomain || '',
                            company_location: this.dataset.companyLocation || '',
                            company_founded: this.dataset.companyFounded || '',
                            company_revenue: this.dataset.companyRevenue || '',
                            company_subindustry: this.dataset.companySubindustry || '',
                            level: this.dataset.level || '',
                            department: this.dataset.department || '',
                            seniority_level: this.dataset.seniorityLevel || '',
                            skills: this.dataset.skills || '',
                            bio: this.dataset.bio || ''
                        };

                        populateModal(leadData);
                        addToListModal.show();
                    });
                });

                function populateModal(leadData) {
                    document.getElementById('leadNameDisplay').textContent = leadData.full_name || 'Unknown';
                    document.getElementById('leadTitleDisplay').textContent =
                        `${leadData.current_title || 'N/A'} at ${leadData.current_company || 'N/A'}`;

                    document.getElementById('modal_external_id').value = leadData.external_id;
                    document.getElementById('modal_first_name').value = leadData.first_name;
                    document.getElementById('modal_last_name').value = leadData.last_name;
                    document.getElementById('modal_full_name').value = leadData.full_name;
                    document.getElementById('modal_email').value = leadData.email;
                    document.getElementById('modal_phone').value = leadData.phone;
                    document.getElementById('modal_linkedin_url').value = leadData.linkedin_url;
                    document.getElementById('modal_current_title').value = leadData.current_title;
                    document.getElementById('modal_current_company').value = leadData.current_company;
                    document.getElementById('modal_company_linkedin_url').value = leadData.company_linkedin_url;
                    document.getElementById('modal_headline').value = leadData.headline;
                    document.getElementById('modal_location').value = leadData.location;
                    document.getElementById('modal_country').value = leadData.country;
                    document.getElementById('modal_region').value = leadData.region;
                    document.getElementById('modal_industry').value = leadData.industry;
                    document.getElementById('modal_company_size').value = leadData.company_size;
                    document.getElementById('modal_company_domain').value = leadData.company_domain;
                    document.getElementById('modal_company_location').value = leadData.company_location;
                    document.getElementById('modal_company_founded').value = leadData.company_founded;
                    document.getElementById('modal_company_revenue').value = leadData.company_revenue;
                    document.getElementById('modal_company_subindustry').value = leadData.company_subindustry;
                    document.getElementById('modal_level').value = leadData.level;
                    document.getElementById('modal_department').value = leadData.department;
                    document.getElementById('modal_seniority_level').value = leadData.seniority_level;
                    document.getElementById('modal_skills').value = leadData.skills;
                    document.getElementById('modal_bio').value = leadData.bio;
                }
            });
        </script>
        {% endblock %}